# OpenKNX Common

OpenKNX Common is a library meant to be used once in every OpenKNX Device firmware.

The main functions are:
- setup and calling the knx stack
- setup and calling of the OpenKNX Modules
- flash handling for persistent data of the OpenKNX Modules

## Usage

It is designed for usage with the headerfile generated by [OpenKNXproducer](https://github.com/OpenKNX/OpenKNXproducer), which provides the necessary defines in knxprod.h:
```
MAIN_OpenKnxId
MAIN_ApplicationNumber
MAIN_ApplicationVersion

# optional (delivered by OAM-LogicModule)
LOG_StartupDelayBase
ParamLOG_StartupDelayTimeMS
LOG_HeartbeatDelayBase
KoLOG_Heartbeat
ParamLOG_HeartbeatDelayTimeMS
```
## Hardware

It is written for use with RP2040 (arduino-pico core) or SAMD21 (arduino core). To configure the Hardware-Setup use the following defines in hardware.h

```
SAVE_INTERRUPT_PIN
INFO_LED_PIN
PROG_BUTTON_PIN
PROG_LED_PIN_ACTIVE_ON
PROG_LED_PIN
KNX_UART_RX_PIN
KNX_UART_TX_PIN
```

## Configuration

| define | default | unit | function |
|---|---:|:---:|---|
| OPENKNX_WATCHDOG | | | compile with watchdog (use only for releases. debugger not working with active watchdog) |
| OPENKNX_WATCHDOG_MAX_PERIOD | 16384 | ms | the timeout period of wathcdog |
| OPENKNX_NO_BOOT_PULSATING | | | Turn off the pulsating LED during the boot phase. (Only necessary for specific hardware where the LED cannot be controlled via PWM). |
| OPENKNX_MAX_MODULES | 9 | | |
| OPENKNX_LEDEFFECT_PULSE_FREQ | 1000 | ms | |
| OPENKNX_LEDEFFECT_BLINK_FREQ | 1000 | ms | |
| OPENKNX_WAIT_FOR_SERIAL | 2000 | ms | wait at startup until SERIAL_DEBUG is connected.<br/>(optional with timeout - in devmode use high values like 20000 - 0 will disable waiting) |
| OPENKNX_HEARTBEAT | 1000 | ms | enable heartbeat mode (optional with with specific failure time) |
| OPENKNX_HEARTBEAT_PRIO | 3000 | ms | enable heartbeat prio mode (optional with with specific failure time) |
| OPENKNX_HEARTBEAT_FREQ | 200 | ms | |
| OPENKNX_HEARTBEAT_PRIO_ON_FREQ | 200 | ms |  |
| OPENKNX_HEARTBEAT_PRIO_OFF_FREQ | 1000 | ms |  |
| OPENKNX_MAX_LOOPTIME | 4000 | Âµs | how much time is the loop allowed to consume. (soft limit) |
| OPENKNX_LOOPTIME_WARNING | 6 | ms | print a warning if the loop has lasted longer. |
| OPENKNX_LOOPTIME_WARNING_INTERVAL | 1000 | ms | how often the warning may be issued in the console |
| OPENKNX_DEBUG | | | Enable debug mode |
| OPENKNX_TRACE1..5 | | | Enable debug mode + tracing. to see trace logs, they must match one of the 5 regex filters. |
| OPENKNX_RTT | | | Enable RTT Mode (Disable USB Serial) + Increase BUFFER_SIZE_UP to 10240! |
| BUFFER_SIZE_UP | 1024 | Bytes | Using by Segger RTT |

### Heartbeat (Mode: Normal)
You can enable a debug heartbeat to see if a loop is stuck. The progLed (for loop) and infoLed (for loop1) will blinking if the loop hangs.

### Heartbeat (Mode: Prio)
In the prio mode the leds blinking (`OPENKNX_HEARTBEAT_PRIO_OFF_FREQ`) and stop as soon as the relevant loop hangs.
If programing mode is active, the progLed will blink faster (`OPENKNX_HEARTBEAT_PRIO_ON_FREQ`).

So, if the device is NOT blinking, anything is wrong.