# OpenKNX Common

OpenKNX Common is a library meant to be used once in every OpenKNX Device firmware.

The main functions are:
- setup and calling the knx stack
- setup and calling of the OpenKNX Modules
- User flash handling for persistent data of the OpenKNX Modules

## Hardware-Support

It is written for use with RP2040 (arduino-pico core) or SAMD21 (arduino core).

## Usage

It is designed for usage with the headerfile generated by [OpenKNXproducer](https://github.com/OpenKNX/OpenKNXproducer), which provides the necessary defines in knxprod.h:
```
MAIN_OpenKnxId
MAIN_ApplicationNumber
MAIN_ApplicationVersion

# optional (delivered by OAM-LogicModule)
LOG_StartupDelayBase
ParamLOG_StartupDelayTimeMS
LOG_HeartbeatDelayBase
KoLOG_Heartbeat
ParamLOG_HeartbeatDelayTimeMS
```

there are external requirements. Add this to your plattformio.ini 
```
lib_deps = 
  adafruit/Adafruit SleepyDog Library @ ^1.4.0
  khoih-prog/TimerInterrupt_Generic @ ^1.13.0
```

## Configuration
OpenKNX Common is configured by following defines:

```
# should be configured in plattformio.ini
WATCHDOG
DEBUG_DELAY
DEBUG_WAIT_FOR_SERIAL
DEBUG_WAIT_FOR_SERIAL_TIMEOUT
DEBUG_LOOP_TIME
DEBUG_HEARTBEAT

# optional (pre defined)
OPENKNX_MAX_LOOPTIME
WATCHDOG_MAX_PERIOD_MS
OPENKNX_MAX_MODULES
OPENKNX_LEDEFFECT_PULSE_FREQ
OPENKNX_LEDEFFECT_BLINK_FREQ

# defines in hardware.h
SAVE_INTERRUPT_PIN
INFO_LED_PIN
PROG_BUTTON_PIN
PROG_LED_PIN_ACTIVE_ON
PROG_LED_SUPPORT_PWM
PROG_LED_PIN
KNX_UART_RX_PIN
KNX_UART_TX_PIN
```

### Delays at startup (for debugging)

There are three defines that control optional functionality regarding delay at startup - mainly to make sure all output on the serial debug console can be read. They are meant to be used in the plattformio.ini

`DEBUG_DELAY` - static delay in ms at startup

example (wait 5s): `-D DEBUG_DELAY=5000`


`DEBUG_WAIT_FOR_SERIAL` - wait at startup until SERIAL_DEBUG is connected. DEBUG_DELAY is ignored

example: `-D DEBUG_WAIT_FOR_SERIAL`


`DEBUG_WAIT_FOR_SERIAL_TIMEOUT` - wait at startup until SERIAL_DEBUG is connected or timeout in ms is over. DEBUG_DELAY is ignored. If no value is defined, it works like `DEBUG_WAIT_FOR_SERIAL`

example (20s timeout): `-D DEBUG_WAIT_FOR_SERIAL_TIMEOUT=20000`

### Debug Loops

#### Heartbeat
You can enable a debug heartbeat to see if a loop is stuck. The progLed (for loop) and infoLed (for loop2) will blinking if the loop hangs

* `DEBUG_HEARTBEAT` - enable heartbeat mode with default failure time (default is 1000ms)
* `DEBUG_HEARTBEAT=3000` - enable heartbeat mode with specific failure time.

#### Heartbeat Prio
You can enable a debug heartbeat to see if the device is stuck. The progLed (for loop) and infoLed (for loop2) are always blinking (`DEBUG_HEARTBEAT_PRIO_OFF_FREQ` default is 1000)

If programing mode is active, the progLed will blink faster (`DEBUG_HEARTBEAT_PRIO_ON_FREQ` default is200)

So, if the device is NOT blinking, anything is wrong.

* `DEBUG_HEARTBEAT_PRIO` - enable heartbeat mode with default failure time (default is 1000ms)
* `DEBUG_HEARTBEAT_PRIO=3000` - enable heartbeat mode with specific failure time.

#### Duration
You can enable a debug output
* `DEBUG_LOOP_TIME` - enable log output when loop tooks longer than default allowed (default is 5ms)
* `DEBUG_LOOP_TIME=6` - enable log output with specific time.
