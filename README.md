# OpenKNX Common

OpenKNX Common is a library meant to be used once in every OpenKNX Device firmware.

The main functions are:
- setup and calling the knx stack
- setup and calling of the OpenKNX Modules
- User flash handling for persistent data of the OpenKNX Modules

## Hardware-Support

It is written for use with RP2040 (arduino-pico core) or SAMD21 (arduino core).

## Usage

It is designed for usage with the headerfile generated by [OpenKNXproducer](https://github.com/OpenKNX/OpenKNXproducer), which provides the necessary defines in knxprod.h:
```
MAIN_OpenKnxId
MAIN_ApplicationNumber
MAIN_ApplicationVersion

# optional (delivered by OAM-LogicModule)
LOG_StartupDelayBase
ParamLOG_StartupDelayTimeMS
LOG_HeartbeatDelayBase
KoLOG_Heartbeat
ParamLOG_HeartbeatDelayTimeMS
```

there are external requirements. Add this to your plattformio.ini 
```
lib_deps = 
  adafruit/Adafruit SleepyDog Library @ ^1.4.0
  khoih-prog/TimerInterrupt_Generic @ ^1.13.0
```

## Configuration
OpenKNX Common is configured by following defines:

```
# should be configured in plattformio.ini
WATCHDOG
DEBUG_DELAY

# optional (pre defined)
WATCHDOG_MAX_PERIOD_MS
OPENKNX_MAX_MODULES
DEBUG_LOOP_TIME

# defines in hardware.h
SAVE_INTERRUPT_PIN
INFO_LED_PIN
PROG_BUTTON_PIN
PROG_LED_PIN_ACTIVE_ON
PROG_LED_PIN
KNX_UART_RX_PIN
KNX_UART_TX_PIN
```

### Delays at startup (for debugging)

There are three defines that control optional functionality regarding delay at startup - mainly to make sure all output on the serial debug console can be read. They are meant to be used in the plattformio.ini

`DEBUG_DELAY` - static delay in ms at startup

example (wait 5s): `-D DEBUG_DELAY=5000`


`DEBUG_WAIT_FOR_SERIAL` - wait at startup until SERIAL_DEBUG is connected. DEBUG_DELAY is ignored

example: `-D DEBUG_WAIT_FOR_SERIAL`


`DEBUG_WAIT_FOR_SERIAL_TIMEOUT` - wait at startup until SERIAL_DEBUG is connected or timeout in ms is over. DEBUG_DELAY is ignored. If no value is defined, it works like `DEBUG_WAIT_FOR_SERIAL`

example (20s timeout): `-D DEBUG_WAIT_FOR_SERIAL_TIMEOUT=20000`